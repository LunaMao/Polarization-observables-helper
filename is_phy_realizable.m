function [MM,mask] = is_phy_realizable(MM)

a = size(MM);
row = a(1);
colum = a(2);

M00 = squeeze(MM(:,:,1,1));
M01 = squeeze(MM(:,:,1,2));
M02 = squeeze(MM(:,:,1,3));
M03 = squeeze(MM(:,:,1,4));

M10 = squeeze(MM(:,:,2,1));
M11 = squeeze(MM(:,:,2,2));
M12 = squeeze(MM(:,:,2,3));
M13 = squeeze(MM(:,:,2,4));

M20 = squeeze(MM(:,:,3,1));
M21 = squeeze(MM(:,:,3,2));
M22 = squeeze(MM(:,:,3,3));
M23 = squeeze(MM(:,:,3,4));

M30 = squeeze(MM(:,:,4,1));
M31 = squeeze(MM(:,:,4,2));
M32 = squeeze(MM(:,:,4,3));
M33 = squeeze(MM(:,:,4,4));



G = diag([1 -1 -1 -1]);
for i = 1 : row
    for j = 1 : colum
        mask(i,j) = isreal(1i);
        N=G * squeeze(MM(i,j,:,:))'*squeeze(MM(i,j,:,:))*G;
        eigenvalues = eig(N);
        [eigenvalues_sorted, Ori_indices] = sort(eigenvalues, 'descend');
        rho_1 = eigenvalues_sorted(1);
        rho_2 = eigenvalues_sorted(2);
        rho_3 = eigenvalues_sorted(3);
        rho_4 = eigenvalues_sorted(4);

        [V, D] = eig(N);
        if isreal(rho_1) && isreal(rho_2) && isreal(rho_3)&& isreal(rho_4)
            largest_v = squeeze(V(:,Ori_indices(1)));
            s0 = largest_v(1);
            s1 = largest_v(2);
            s2 = largest_v(3);
            s3 = largest_v(4);
            dop = sqrt((s1^2+s2^2+s3^2)/s0^2);
            if (dop>0) && (dop<=1)
                mask(i,j) = isreal(1);
            end

        end

         
    end
end

M00 = M00.*mask;
M01 = M01.*mask;
M02 = M02.*mask;
M03 = M03.*mask;

M10 = M10.*mask;
M11 = M11.*mask;
M12 = M12.*mask;
M13 = M13.*mask;

M20 = M20.*mask;
M21 = M21.*mask;
M22 = M22.*mask;
M23 = M23.*mask;

M30 = M30.*mask;
M31 = M31.*mask;
M32 = M32.*mask;
M33 = M33.*mask;


MM(:,:,1,1)=M00;
MM(:,:,1,2)=M01;
MM(:,:,1,3)=M02;
MM(:,:,1,4)=M03;
MM(:,:,2,1)=M10;
MM(:,:,2,2)=M11;
MM(:,:,2,3)=M12;
MM(:,:,2,4)=M13;
MM(:,:,3,1)=M20;
MM(:,:,3,2)=M21;
MM(:,:,3,3)=M22;
MM(:,:,3,4)=M23;
MM(:,:,4,1)=M30;
MM(:,:,4,2)=M31;
MM(:,:,4,3)=M32;
MM(:,:,4,4)=M33;

% if if_fourphase
%     MM = zeros(4,51,51,4,4);
% 
%     % Remeber to modify!
% 
% 
%     % region 1
%     MM(1,:,:,1,1) = M00(1:51,1:51);
%     MM(1,:,:,1,2) = M01(1:51,1:51);
%     MM(1,:,:,1,3) = M02(1:51,1:51);
%     MM(1,:,:,1,4) = M03(1:51,1:51);
% 
%     MM(1,:,:,2,1) = M10(1:51,1:51);
%     MM(1,:,:,2,2) = M11(1:51,1:51);
%     MM(1,:,:,2,3) = M12(1:51,1:51);
%     MM(1,:,:,2,4) = M13(1:51,1:51);
% 
%     MM(1,:,:,3,1) = M20(1:51,1:51);
%     MM(1,:,:,3,2) = M21(1:51,1:51);
%     MM(1,:,:,3,3) = M22(1:51,1:51);
%     MM(1,:,:,3,4) = M23(1:51,1:51);
% 
%     MM(1,:,:,4,1) = M30(1:51,1:51);
%     MM(1,:,:,4,2) = M31(1:51,1:51);
%     MM(1,:,:,4,3) = M32(1:51,1:51);
%     MM(1,:,:,4,4) = M33(1:51,1:51);
% 
%     % region 2
% 
%     MM(2,:,:,1,1) = M00(1:51,51:101);
%     MM(2,:,:,1,2) = M01(1:51,51:101);
%     MM(2,:,:,1,3) = M02(1:51,51:101);
%     MM(2,:,:,1,4) = M03(1:51,51:101);
% 
%     MM(2,:,:,2,1) = M10(1:51,51:101);
%     MM(2,:,:,2,2) = M11(1:51,51:101);
%     MM(2,:,:,2,3) = M12(1:51,51:101);
%     MM(2,:,:,2,4) = M13(1:51,51:101);
% 
%     MM(2,:,:,3,1) = M20(1:51,51:101);
%     MM(2,:,:,3,2) = M21(1:51,51:101);
%     MM(2,:,:,3,3) = M22(1:51,51:101);
%     MM(2,:,:,3,4) = M23(1:51,51:101);
% 
%     MM(2,:,:,4,1) = M30(1:51,51:101);
%     MM(2,:,:,4,2) = M31(1:51,51:101);
%     MM(2,:,:,4,3) = M32(1:51,51:101);
%     MM(2,:,:,4,4) = M33(1:51,51:101);
% 
% 
%     % region 3
% 
%     MM(3,:,:,1,1) = M00(51:101,1:51);
%     MM(3,:,:,1,2) = M01(51:101,1:51);
%     MM(3,:,:,1,3) = M02(51:101,1:51);
%     MM(3,:,:,1,4) = M03(51:101,1:51);
% 
%     MM(3,:,:,2,1) = M10(51:101,1:51);
%     MM(3,:,:,2,2) = M11(51:101,1:51);
%     MM(3,:,:,2,3) = M12(51:101,1:51);
%     MM(3,:,:,2,4) = M13(51:101,1:51);
% 
%     MM(3,:,:,3,1) = M20(51:101,1:51);
%     MM(3,:,:,3,2) = M21(51:101,1:51);
%     MM(3,:,:,3,3) = M22(51:101,1:51);
%     MM(3,:,:,3,4) = M23(51:101,1:51);
% 
%     MM(3,:,:,4,1) = M30(51:101,1:51);
%     MM(3,:,:,4,2) = M31(51:101,1:51);
%     MM(3,:,:,4,3) = M32(51:101,1:51);
%     MM(3,:,:,4,4) = M33(51:101,1:51);
% 
%     % region 4
% 
%     MM(4,:,:,1,1) = M00(51:101,51:101);
%     MM(4,:,:,1,2) = M01(51:101,51:101);
%     MM(4,:,:,1,3) = M02(51:101,51:101);
%     MM(4,:,:,1,4) = M03(51:101,51:101);
% 
%     MM(4,:,:,2,1) = M10(51:101,51:101);
%     MM(4,:,:,2,2) = M11(51:101,51:101);
%     MM(4,:,:,2,3) = M12(51:101,51:101);
%     MM(4,:,:,2,4) = M13(51:101,51:101);
% 
%     MM(4,:,:,3,1) = M20(51:101,51:101);
%     MM(4,:,:,3,2) = M21(51:101,51:101);
%     MM(4,:,:,3,3) = M22(51:101,51:101);
%     MM(4,:,:,3,4) = M23(51:101,51:101);
% 
%     MM(4,:,:,4,1) = M30(51:101,51:101);
%     MM(4,:,:,4,2) = M31(51:101,51:101);
%     MM(4,:,:,4,3) = M32(51:101,51:101);
%     MM(4,:,:,4,4) = M33(51:101,51:101);
% 
% 
% 
% 
%     % % four regions  
%     % if (xp>0)&&(xp<=xmax/2)&&(yp>0)&&(yp<=ymax/2)
%     %     index = 1;
%     % elseif (xp>xmax/2)&&(xp<xmax)&&(yp>0)&&(yp<=ymax/2) 
%     %     index = 2;
%     % elseif (xp>0)&&(xp<=xmax/2)&&(yp>ymax/2)&&(yp<ymax) 
%     %     index = 3;
%     % elseif (xp>xmax/2)&&(xp<xmax)&&(yp>ymax/2)&&(yp<ymax) 
%     %     index = 4;
%     %  end
% 
% end
